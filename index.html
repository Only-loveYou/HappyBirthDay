<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musical Matrix Wedding</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Courier New', Courier, monospace;
        }
        canvas {
            display: block;
        }
        /* Style cho n√∫t ph√°t nh·∫°c */
        #startBtn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            font-size: 20px;
            background: transparent;
            color: #ff69b4;
            border: 2px solid #ff69b4;
            cursor: pointer;
            z-index: 100;
            border-radius: 50px;
            box-shadow: 0 0 15px #ff69b4;
            transition: all 0.3s;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        #startBtn:hover {
            background: #ff69b4;
            color: white;
            box-shadow: 0 0 30px #ff69b4;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 105, 180, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 105, 180, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 105, 180, 0); }
        }
    </style>
</head>
<body>

<audio id="bgMusic" loop>
    <source src="HPBDD.MP3" type="audio/mpeg">
    Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ audio.
</audio>

<button id="startBtn">üë∞ T ‚ô•Ô∏è H ü§µ</button>
<canvas id="canvas"></canvas>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const btn = document.getElementById('startBtn');
    const audio = document.getElementById('bgMusic');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // --- C·∫§U H√åNH ---
    const CONFIG = {
        bgSpeed: 20,           
        bgFade: 0.1,           
        particleEase: 0.05,    
        textScale: 100,        
        gap: 5                 
    };

    const chars = 'HAPPYWEDDING';
    const charArray = chars.split('');
    
    // --- KH·ªûI T·∫†O ---
    const fontSize = 14;
    const columns = canvas.width / fontSize;
    const drops = [];
    for (let i = 0; i < columns; i++) drops[i] = 1;

    let particles = [];
    
    class MatrixParticle {
        constructor(x, y) {
            this.targetX = x;
            this.targetY = y;
            if (Math.random() > 0.5) {
                this.x = Math.random() > 0.5 ? -50 : canvas.width + 50;
                this.y = Math.random() * canvas.height;
            } else {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() > 0.5 ? -50 : canvas.height + 50;
            }
            this.char = charArray[Math.floor(Math.random() * charArray.length)];
            this.color = '#ff69b4'; 
        }

        update() {
            this.x += (this.targetX - this.x) * CONFIG.particleEase;
            this.y += (this.targetY - this.y) * CONFIG.particleEase;
            if (Math.random() > 0.95) {
                this.char = charArray[Math.floor(Math.random() * charArray.length)];
            }
        }

        draw() {
            ctx.fillStyle = this.color;
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#ff1493'; 
            ctx.fillText(this.char, this.x, this.y);
            ctx.shadowBlur = 0; 
        }

        changeTarget(newX, newY) {
            this.targetX = newX;
            this.targetY = newY;
        }
    }

    function getTextCoordinates(text) {
        const bgCanvas = document.createElement('canvas');
        const bgCtx = bgCanvas.getContext('2d');
        bgCanvas.width = canvas.width;
        bgCanvas.height = canvas.height;

        let size = CONFIG.textScale;
        if (text.length > 5 && text.length <= 10) size = size * 0.9; 
        if (text.length > 10) size = size * 0.7; 

        bgCtx.font = `bold ${size}px Arial`;
        bgCtx.fillStyle = '#fff';
        bgCtx.textAlign = 'center';
        bgCtx.textBaseline = 'middle';

        const lines = text.split('\n');
        const lineHeight = size * 1.0; 
        const startY = (canvas.height - (lines.length - 1) * lineHeight) / 2;

        lines.forEach((line, index) => {
            bgCtx.fillText(line, canvas.width / 2, startY + (index * lineHeight));
        });

        const imageData = bgCtx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        const coords = [];

        for (let y = 0; y < canvas.height; y += CONFIG.gap) {
            for (let x = 0; x < canvas.width; x += CONFIG.gap) {
                if (data[(y * canvas.width + x) * 4 + 3] > 128) {
                    coords.push({ x, y });
                }
            }
        }
        return coords;
    }

    function initParticles(text) {
        const coords = getTextCoordinates(text);
        if (particles.length < coords.length) {
            const diff = coords.length - particles.length;
            for (let i = 0; i < diff; i++) {
                particles.push(new MatrixParticle(canvas.width/2, canvas.height/2));
            }
        }
        particles.forEach((p, i) => {
            if (i < coords.length) {
                p.changeTarget(coords[i].x, coords[i].y);
                p.color = '#ff69b4'; 
            } else {
                p.changeTarget(Math.random() * canvas.width, Math.random() * canvas.height);
                p.color = 'rgba(0,0,0,0)'; 
            }
        });
    }

    const timeline = [
        { text: "3", time: 5500 },
            { text: "2", time: 3500 },
            { text: "1", time: 3500 },
            { text: "HAPPY WEDDING", time: 8000 },
            { text: "ANH TH∆Ø\n‚ù§Ô∏è\n QUANG HUY", time: 8000 },
            { text: "04.01.2026", time: 8000 },
            { text: "TEAM BABIPRO\nCH√öC HAI ANH CH·ªä\nTRƒÇM NƒÇM H·∫†NH PH√öC", time: 10000 },
            { text: "M√ÉI IU H·∫∏ H·∫∏ H·∫∏ =))", time: 8000 }
    ];
    let currentStep = 0;

    function runTimeline() {
        if (currentStep >= timeline.length) currentStep = 3; 
        initParticles(timeline[currentStep].text);
        setTimeout(() => {
            currentStep++;
            runTimeline();
        }, timeline[currentStep].time);
    }

    let lastTime = 0;
    const interval = 1000 / CONFIG.bgSpeed;

    function draw(currentTime) {
        requestAnimationFrame(draw);

        const deltaTime = currentTime - lastTime;
        if (deltaTime < interval) return;
        lastTime = currentTime - (deltaTime % interval);

        ctx.fillStyle = `rgba(0, 0, 0, ${CONFIG.bgFade})`;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.font = fontSize + 'px monospace';

        // V·∫Ω n·ªÅn m∆∞a
        ctx.shadowBlur = 8;  
        ctx.shadowColor = 'rgba(255, 255, 255, 0.8)'; 
        for (let i = 0; i < drops.length; i++) {
            const text = charArray[Math.floor(Math.random() * charArray.length)];
            const x = i * fontSize;
            const y = drops[i] * fontSize;
            ctx.fillStyle = '#ffffff'; 
            ctx.fillText(text, x, y);
            if (y > canvas.height && Math.random() > 0.975) {
                drops[i] = 0;
            }
            drops[i]++;
        }
        ctx.shadowBlur = 0;

        // V·∫Ω ch·ªØ
        particles.forEach(p => {
            p.update();
            if (p.color !== 'rgba(0,0,0,0)') { 
                p.draw();
            }
        });
    }

    // --- S·ª∞ KI·ªÜN N√öT B·∫§M ---
    btn.addEventListener('click', () => {

        // Ch·∫°y n·ªÅn m∆∞a ngay l·∫≠p t·ª©c khi m·ªü web
        draw(0);

        // 1. Ph√°t nh·∫°c
        audio.play().catch(e => console.log("L·ªói ph√°t nh·∫°c: ", e));
        
        // 2. ·∫®n n√∫t
        btn.style.display = 'none';

        // 3. ƒê·ª£i 3 gi√¢y r·ªìi b·∫Øt ƒë·∫ßu hi·ªán ch·ªØ
        setTimeout(() => {
            initParticles(timeline[0].text);
            runTimeline();
        }, 3000);
    });

    

    // Resize
    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        if (currentStep < timeline.length && btn.style.display === 'none') {
            initParticles(timeline[currentStep].text);
        }
    });

</script>
</body>
</html>
